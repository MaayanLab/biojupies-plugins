#################################################################
#################################################################
############### DE 
#################################################################
#################################################################

#############################################
########## 1. Load libraries
#############################################
##### 1. General support #####
import requests
import json
import pandas as pd
from IPython.display import display, Markdown
from plotly import tools
from plotly.offline import iplot
import plotly.graph_objs as go

##### 2. Other libraries #####


#######################################################
#######################################################
########## S1. Function
#######################################################
#######################################################

#############################################
########## 1. Run
#############################################

def get_genesets(signature_dataframe, signature_col, top_n=True, nr_genes=500):
	genesets = {}
	sorted_genes = signature_dataframe.sort_values(signature_col).index
	genesets['upregulated'] = sorted_genes[-500:]
	genesets['downregulated'] = sorted_genes[:500]
	return genesets

def submit_enrichr_geneset(geneset):
	ENRICHR_URL = 'http://amp.pharm.mssm.edu/Enrichr/addList'
	genes_str = '\n'.join(geneset)
	payload = {
	'list': (None, genes_str),
	}
	response = requests.post(ENRICHR_URL, files=payload)
	if not response.ok:
		raise Exception('Error analyzing gene list')
	data = json.loads(response.text)
	return data

def run(signature, geneset_size=500, libraries=['GO_Biological_Process_2017b', 'ENCODE_TF_ChIP-seq_2015', 'KEGG_2016', 'ARCHS4_TFs_Coexp', 'MGI_Mammalian_Phenotype_2017', 'Allen_Brain_Atlas_up'], signature_label=''):

	# Get genesets
	genesets = {}
	genesets['upregulated'] = signature.index[:geneset_size]
	genesets['downregulated'] = signature.index[-geneset_size:]

	# Submit to Enrichr
	enrichr_ids = {geneset_label: submit_enrichr_geneset(geneset=geneset) for geneset_label, geneset in genesets.items()}
	enrichr_ids['signature_label'] = signature_label
	return enrichr_ids

#############################################
########## 2. Plot
#############################################

def plot(enrichr_results, plot_counter):
	display(Markdown('##### {signature_label} Signature:\n * Upregulated: https://amp.pharm.mssm.edu/Enrichr/enrich?dataset={upregulated[shortId]} \n * Downregulated: https://amp.pharm.mssm.edu/Enrichr/enrich?dataset={downregulated[shortId]}'.format(**enrichr_results)))

	# Figure Legend
	display(Markdown('** Table '+plot_counter('table')+' | Enrichr links. **The table displays links to Enrichr containing the results of enrichment analyses generated by analyzing the up-regulated and down-regulated genes from a differential expression analysis. By clicking on these links, users can interactively explore and download the enrichment results from the Enrichr website'.format(**locals())))

